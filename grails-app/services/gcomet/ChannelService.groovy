package gcometimport org.grails.plugin.gcomet.GCometChannelSubscriberimport org.grails.plugin.gcomet.SubscribeMessageimport org.grails.plugin.gcomet.UnsubscribeMessageimport org.grails.plugin.gcomet.UpdateComponentStateMessageimport org.grails.plugin.gcomet.GetComponentStateMessageimport org.grails.plugin.gcomet.GCometComponentStateclass ChannelService {	static scope = 'session'	def subscribers = []		def subscribeCurrentUserTo(channel){		def subscriber = new GCometChannelSubscriber()		subscriber.start()		subscribe(subscriber, channel)		subscribers << subscriber	}		def subscribe(subscriber, channel) {		channel << new SubscribeMessage(subscriber: subscriber)	}		def unsubscribe(subscriber, channel) {		channel << new UnsubscribeMessage(subscriber: subscriber)	}		def update(GCometComponentState state, channel) {		channel << new UpdateComponentStateMessage(state: state.clone())	}		def retrieveStateUpdatesForUser(){		subscribers.collectMany{[it.sendAndWait(new GetComponentStateMessage())]}	}}